<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="sv-SE" xml:lang="sv-SE"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>9&nbsp; Simultan inferens – Statistisk teori och tillämpningar i R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../01-regression/06-complex-predictors.html" rel="next">
<link href="../01-regression/04-statistical-inference.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-96e8a2c236aee144da7b9dc077376cca.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Inget resultat",
    "search-matching-documents-text": "matchande dokument",
    "search-copy-link-title": "Kopiera länk för att söka",
    "search-hide-matches-text": "Göm ytterligare resultat",
    "search-more-match-text": "annat resultat i detta dokument",
    "search-more-matches-text": "fler resultat i detta dokument",
    "search-clear-button-title": "Rensa",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Avbryt",
    "search-submit-button-title": "Verkställ",
    "search-label": "Sök"
  }
}</script>
<script src="../site_libs/kePrint-0.0.1/kePrint.js"></script>

<link href="../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
<link rel="stylesheet" href="../webex.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Statistisk teori och tillämpningar i R</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Skifta navigering" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../00-programming/00-basics-R.html" aria-current="page"> 
<span class="menu-text">Programmering i R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../01-regression/index.html"> 
<span class="menu-text">Regressionsanalys</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../02-variance/index.html"> 
<span class="menu-text">Varianssanalys</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../04-time-series/index.html"> 
<span class="menu-text">Tidsserieanalys</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Skifta sidonavigering" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../01-regression/index.html">DEL II - Regressionsanalys</a></li><li class="breadcrumb-item"><a href="../01-regression/05-simultaneous-inference.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Simultan inferens</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Skifta sidonavigering" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Sök" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Sök"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Inledning</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text"><strong>DEL I - Programmering i R</strong></span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Skifta sektion">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../00-programming/00-basics-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Grunderna i R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../00-programming/01-packages-and-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Paket och funktioner</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../00-programming/02-tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">tidyverse</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../01-regression/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DEL II - Regressionsanalys</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Skifta sektion">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/00-intro-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Introduktion till regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/01-explorative-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Utforska samband</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/02-model-structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Modellanpassning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/03-model-assessment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Modellutvärdering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/04-statistical-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Statistisk inferens</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/05-simultaneous-inference.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Simultan inferens</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/06-complex-predictors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Komplexa samband</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/07-multicollinearity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Multikollinearitet</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/08-detailed-residuals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Detaljerad residualanalys</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/09-variable-selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Modellvalidering och variabelselektion</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/10-logistic-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Logistisk regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01-regression/11-other-link-functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Andra länkfunktioner</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../02-variance/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DEL III - Variansanalys</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Skifta sektion">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02-variance/00-oneway-anova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Introduktion till variansanalys</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02-variance/01-random-factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Slumpmässiga faktorer</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02-variance/02-control-variables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Kontrollvariabler</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02-variance/03-twoway-anova.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Tvåvägs-ANOVA</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../04-time-series/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DEL IV - Tidsserieanalys</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Skifta sektion">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04-time-series/00-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Introduktion</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04-time-series/01-properties.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Tidsserier</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04-time-series/02-ar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Autoregressiva modeller</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04-time-series/03-arima.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">ARIMA</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04-time-series/04-arimax.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">ARIMAx</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Innehållsförteckning</h2>
   
  <ul>
  <li><a href="#simultan-inferens" id="toc-simultan-inferens" class="nav-link active" data-scroll-target="#simultan-inferens"><span class="header-section-number">9.1</span> Simultan inferens</a>
  <ul class="collapse">
  <li><a href="#simulering" id="toc-simulering" class="nav-link" data-scroll-target="#simulering"><span class="header-section-number">9.1.1</span> Simulering</a></li>
  <li><a href="#familjekonfidens" id="toc-familjekonfidens" class="nav-link" data-scroll-target="#familjekonfidens"><span class="header-section-number">9.1.2</span> Familjekonfidens</a></li>
  <li><a href="#familjekonfidens-för-lutningsparametrar" id="toc-familjekonfidens-för-lutningsparametrar" class="nav-link" data-scroll-target="#familjekonfidens-för-lutningsparametrar"><span class="header-section-number">9.1.3</span> Familjekonfidens för lutningsparametrar</a></li>
  </ul></li>
  <li><a href="#intervallskattning-av-flera-prediktioner" id="toc-intervallskattning-av-flera-prediktioner" class="nav-link" data-scroll-target="#intervallskattning-av-flera-prediktioner"><span class="header-section-number">9.2</span> Intervallskattning av flera prediktioner</a>
  <ul class="collapse">
  <li><a href="#skattning-av-flera-konfidensintervall" id="toc-skattning-av-flera-konfidensintervall" class="nav-link" data-scroll-target="#skattning-av-flera-konfidensintervall"><span class="header-section-number">9.2.1</span> Skattning av flera konfidensintervall</a></li>
  <li><a href="#skattning-av-flera-prediktionsintervall" id="toc-skattning-av-flera-prediktionsintervall" class="nav-link" data-scroll-target="#skattning-av-flera-prediktionsintervall"><span class="header-section-number">9.2.2</span> Skattning av flera prediktionsintervall</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../01-regression/index.html">DEL II - Regressionsanalys</a></li><li class="breadcrumb-item"><a href="../01-regression/05-simultaneous-inference.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Simultan inferens</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-family-confidence" class="quarto-section-identifier"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Simultan inferens</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- New commands for matrices in regression -->
<!-- Creates a shortcommand for sums -->
<!-- CONTENT -->
<p>När en modell har undersökts med hjälp av residualanalys och statistisk inferens och vi kommit fram till att den är en lämplig och bra förenkling av verkligheten, kan vi börja använda den för att dra lärdomar om sambandet och prediktera nya observationer. Vi har i <a href="04-statistical-inference.html#sec-stat-inference" class="quarto-xref"><span>Avsnitt 8.2</span></a> redan fått några lärdomar om hur sambandet mellan vissa variabler ser ut men om vi vill tolka flera parametrar från modellen samtidigt bör vi tillämpa någon form av <strong>simultan inferens</strong>. En utav regressionsmodellers huvudsakliga användningsområden är att <strong>prediktera</strong> nya observationer. Till exempel kan responsvariabeln vara väldigt kostsam att mäta jämfört med de förklarande variablerna. Då kan en lämplig och bra regressionsmodellen minska kostnaderna genom att intervallskatta värdet på responsvariabeln utifrån givna värden på de förklarande variablerna. Prediktioner kan också användas för beslutsunderlag, till exempel kan en regressionsmodell ge information om förväntade inkomster givet en viss reklambudget.</p>
<section id="simultan-inferens" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="simultan-inferens"><span class="header-section-number">9.1</span> Simultan inferens</h2>
<p>När en modell innehåller flera förklarande variabler, alla med minst en tillhörande lutningsparameter, kommer vi genomföra flera inferensberäkningar om vi vill dra slutsatser om flera parametrar eller intervallskatta prediktioner för flera nya observationer. Varje hypotesprövning eller intervallskattning som beräknas utgår från att vi alltid har en risk att fatta fel beslut, vilket innebär att denna risk inflateras ju fler parametrar eller värden som undersöks med enskilda beräkningar. Typ I felet (signifikansnivån) beskriver risken att förkasta en sann <span class="math inline">\(H_0\)</span>.</p>
<p>Den satiriska vetenskapliga serietecknaren <a href="https://xkcd.com">xkcd</a> har publicerat en serie som berör signifikansen av hypotesprövningar.</p>
<div id="fig-jelly-bean" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-jelly-bean-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://imgs.xkcd.com/comics/significant.png" class="img-fluid figure-img" width="600"></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-jelly-bean-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figur&nbsp;9.1: <a href="https://xkcd.com/882">xkcd</a>, <a href="https://creativecommons.org/licenses/by-nc/2.5/">CC BY-NC 2.5</a>
</figcaption>
</figure>
</div>
<p>En grupp forskare, som hellre vill spela Minecraft, har fått i uppdrag att undersöka effekten av Jelly Beans på förekomsten av acne. Forskarna undersöker 20 olika färger av Jelly Beans med en signifikansnivå på fem procent. En utav färgerna visade sig ha en signifikant påverkan på förekomsten av acne och som vi ser i nyhetsartikeln allra sist i serien blir denna upptäckt innehållet på första sidan.</p>
<p>Vad är det som faktiskt har hänt här och är det korrekt att annonsera ut detta för världen? Vi kan skapa ett liknande simulerat exempel genom att genomföra 20 stycken urval från en population där vi vet det sanna medelvärdet.</p>
<section id="simulering" class="level3" data-number="9.1.1">
<h3 data-number="9.1.1" class="anchored" data-anchor-id="simulering"><span class="header-section-number">9.1.1</span> Simulering</h3>
<div class="cell">
<details class="code-fold">
<summary>Visa kod</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Anger ett seed</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Simulerar ett datamaterial från en given population med sanna värden</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replicate</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">20</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">expr =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">30</span>, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Kopiera till urklipp" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Objektet <code>data</code> innehåller nu 20 stycken kolumner med 30 observationer i varje och varje kolumn är ett nytt urval (motsvarande en undersökning av en färg Jelly Bean). Alla dessa urval kommer från en population där <span class="math inline">\(\mu = 0\)</span> och det skulle vi kunna undersöka genom ett enkelt t-test för ett medelvärde. Formellt undersöks hypoteserna:</p>
<p><span class="math display">\[
\begin{aligned}
  H_0 &amp;: \mu = 0\\
  H_A &amp;: \mu \ne 0
\end{aligned}
\]</span></p>
<p>där testvariabeln är <span class="math display">\[
t_{test} = \frac{\bar{x} - 0}{ \frac{s}{\sqrt{n}}}
\]</span></p>
<div class="cell">
<details class="code-fold">
<summary>Visa kod</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Testvariabeln för första urvalet</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>tTest <span class="ot">&lt;-</span> (<span class="fu">mean</span>(data[,<span class="dv">1</span>]) <span class="sc">-</span> <span class="dv">0</span>) <span class="sc">/</span> (<span class="fu">sd</span>(data[,<span class="dv">1</span>]) <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">nrow</span>(data))) </span></code></pre></div><button title="Kopiera till urklipp" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>p-värdet för testet kan beräknas utifrån t-fördelningen med <span class="math inline">\(n - 1\)</span> frihetsgrader. Vi måste dock ta hänsyn till att vi undersöker en dubbelsidig mothypotes vilket innebär att p-värdet är både större än den positiva testvariabeln och mindre än den negativa testvariabeln. Med hjälp av symmetrin i t-fördelningen kan vi räkna ut detta genom att beräkna absolutbeloppet av testvariabeln och multiplicera ytan större än detta värde med <span class="math inline">\(2\)</span>.</p>
<div class="cell">
<details class="code-fold">
<summary>Visa kod</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Beräkning av p-värdet</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>pValue <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">pt</span>(<span class="at">q =</span> <span class="fu">abs</span>(tTest), <span class="at">df =</span> <span class="fu">nrow</span>(data) <span class="sc">-</span> <span class="dv">1</span>, <span class="at">lower.tail =</span> <span class="cn">FALSE</span>) </span></code></pre></div><button title="Kopiera till urklipp" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Vi kan också använda inbyggda funktionen <code>t.test()</code> för att få fram samma resultat, där standardargumentet är att vi undersöker om populationsmedelvärdet är skilt från 0.</p>
<div class="cell">
<details class="code-fold">
<summary>Visa kod</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(data[,<span class="dv">1</span>])</span></code></pre></div><button title="Kopiera till urklipp" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    One Sample t-test

data:  data[, 1]
t = 0.46006, df = 29, p-value = 0.6489
alternative hypothesis: true mean is not equal to 0
95 percent confidence interval:
 -0.2715323  0.4291463
sample estimates:
 mean of x 
0.07880701 </code></pre>
</div>
</div>
<p>Vi kan replikera detta test och spara p-värdet för alla 20 olika utval med hjälp av <code>apply()</code>. Funktionen genomför en angiven funktion för varje element i ett objekt, i detta fall anger vi att den ska genomföra beräkningen för varje kolumn (<code>MARGIN = 2</code>) i objektet <code>data</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Visa kod</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Kör samma funktion (t.test) för varje kolumn (MARGIN = 2) av datamaterialet</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>pValues <span class="ot">&lt;-</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> data,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">MARGIN =</span> <span class="dv">2</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t.test</span>(x)<span class="sc">$</span>p.value</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Kopiera till urklipp" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell" data-tbl-cap-location="top">
<div id="tbl-family-confidence" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-cap-location="top">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-family-confidence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Tabell&nbsp;9.1: p-värden för t-testet i respektive urval
</figcaption>
<div aria-describedby="tbl-family-confidence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table quarto-disable-processing="true" class="table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> p-värde </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0.649 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.195 </td>
  </tr>
  <tr>
   <td style="text-align:right;font-weight: bold;"> 0.036 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.895 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.806 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.978 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.341 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.765 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.981 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.269 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.092 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.497 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.228 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.467 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.114 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.333 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.268 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.790 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.290 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.896 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>I <a href="#tbl-family-confidence" class="quarto-xref">Tabell&nbsp;<span>9.1</span></a> är det endast ett test vars tillhörande p-värde är mindre än <span class="math inline">\(\alpha = 0.05\)</span> (urval 3), motsvarande den gröna Jelly Bean. Eftersom vi skapat dessa urval från en sann fördelning, vet vi att populationen har medelvärde 0 vilket innebär att vi gör ett fel av typ I, förkastar en sann <span class="math inline">\(H_0\)</span>. Med en signifikansnivå på 5 procent räknar vi att i 1 av 20 fall (5%) så fattar vi fel beslut utav ren slump. Desto fler tester som genomförs desto större risk att minst en av dessa tester kommer generera ett typ I-fel och att tolka ett enskilt test med 5 procents signifikans är missvisande.</p>
<p>Under antagandet att de olika urvalen är oberoende av varandra kan vi räkna ut den slutgiltiga risken för typ-I fel i minst en av testerna med hjälp av multiplikationssatsen för oberoende händelser:</p>
<p><span class="math display">\[
\begin{aligned}
1 - (0.95 \cdot 0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 &amp;\cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95 \cdot  0.95)\\
&amp;1 - (0.95^{20})\\
&amp;0.6415141
\end{aligned}
\]</span> Risken att minst en utav 20 tester har förkastat en sann <span class="math inline">\(H_0\)</span> är istället ca 64% istället för 5%.</p>
</section>
<section id="familjekonfidens" class="level3" data-number="9.1.2">
<h3 data-number="9.1.2" class="anchored" data-anchor-id="familjekonfidens"><span class="header-section-number">9.1.2</span> Familjekonfidens</h3>
<p>När vi genomför flera tester kan vi istället justera konfidensgraden för varje individuella test så att vi får en sammanfattande konfidensnivå som vi också använder i tolkningen. Den enklaste varianten är att beräkna Bonferronis familjekonfidens där konfidensgraden beräknas enligt: <span class="math display">\[
\begin{aligned}
  1 - \alpha/2 \Rightarrow 1 - \alpha/(2 \cdot g)
\end{aligned}
\]</span> där <span class="math inline">\(g\)</span> är antalet tester som genomförs.</p>
<div class="cell" data-tbl-cap-location="top">
<details class="code-fold">
<summary>Visa kod</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plockar ur testvariabeln</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>statistic <span class="ot">&lt;-</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> data,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">MARGIN =</span> <span class="dv">2</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> <span class="cf">function</span>(x){</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">t.test</span>(x)<span class="sc">$</span>statistic</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="st">`</span><span class="at">Testvariabel</span><span class="st">`</span> <span class="ot">=</span> statistic) <span class="sc">|&gt;</span> </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="st">"striped"</span>, <span class="at">full_width =</span> <span class="cn">FALSE</span>) </span></code></pre></div><button title="Kopiera till urklipp" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div id="tbl-family-statistic" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-tbl-cap-location="top">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-family-statistic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Tabell&nbsp;9.2: Beräknad testvariabel för respektive urval
</figcaption>
<div aria-describedby="tbl-family-statistic-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table quarto-disable-processing="true" class="table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> Testvariabel </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0.460 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1.328 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 2.196 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.134 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.248 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.028 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.969 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.302 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.024 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -1.127 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1.744 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.689 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1.231 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.737 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1.629 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.984 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -1.129 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.268 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1.077 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 0.132 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Det justerade kritiska tabellvärdet är <span class="math inline">\(\pm t_{30 - 1, 1 - 0.05 / (2 \cdot 20)} = \pm\)</span> 3.31 istället för <span class="math inline">\(\pm t_{30 - 1, 1 - 0.05 / (2)} = \pm\)</span> 2.045 vilket innebär att ingen testvariabel i <a href="#tbl-family-statistic" class="quarto-xref">Tabell&nbsp;<span>9.2</span></a> ligger extremare än det justerade. Med en simultan signifikansnivå på fem procent förkastas ingen av testernas nollhypoteser.</p>
</section>
<section id="familjekonfidens-för-lutningsparametrar" class="level3" data-number="9.1.3">
<h3 data-number="9.1.3" class="anchored" data-anchor-id="familjekonfidens-för-lutningsparametrar"><span class="header-section-number">9.1.3</span> Familjekonfidens för lutningsparametrar</h3>
<p>Med hjälp av Bonferroni:s familjekonfidens kan vi justera formlerna för intervallskattning av lutningsparametrarna. En generell formel för en intervallskattning kan skrivas såsom: <span id="eq-interval-base"><span class="math display">\[
\text{punktskattning} \pm \text{tabellvärde} \cdot \text{medelfel}
\tag{9.1}\]</span></span></p>
<p>I fallet för <span class="math inline">\(\beta_1\)</span> blir formeln: <span class="math display">\[
    b_1 \pm t_{n - (k+1); 1- \alpha/2} \cdot s_{b_1}
\]</span> Bonferroni:s familjekonfidens leder till att formeln justeras enligt: <span class="math display">\[
    b_1 \pm t_{n - (k+1); 1- \alpha/(2\cdot g)} \cdot s_{b_1}
\]</span> , där <span class="math inline">\(g\)</span> är antalet lutningsparametrar som ska undersökas samtidigt.</p>
<p><span class="math inline">\(t_{n-(k+1); 1 - \alpha/(2\cdot g)}\)</span> brukar också anges som <span class="math inline">\(B\)</span>. När <span class="math inline">\(g\)</span> är stort, kommer värden från <span class="math inline">\(t\)</span>-fördelningen också vara stora vilket i slutändan kan leda till intervall som inte ger någon vettig information. Därför följer att Bonferronis metod är lämpligast att användas när antalet intervall eller tester är få.</p>
</section>
</section>
<section id="intervallskattning-av-flera-prediktioner" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="intervallskattning-av-flera-prediktioner"><span class="header-section-number">9.2</span> Intervallskattning av flera prediktioner</h2>
<p>Om vi är intresserade av att prediktera flera nya observationer kommer vi behöva använda simultan inferens för att samtidigt dra slutsatser om de alla.</p>
<section id="skattning-av-flera-konfidensintervall" class="level3" data-number="9.2.1">
<h3 data-number="9.2.1" class="anchored" data-anchor-id="skattning-av-flera-konfidensintervall"><span class="header-section-number">9.2.1</span> Skattning av flera konfidensintervall</h3>
<p>Om vi vill beräkna konfidensband för hela regressionslinjen, i.e.&nbsp;<span class="math inline">\(\mu_Y\)</span> för alla punkter av <span class="math inline">\(\mathbf{X}\)</span>, kan <strong>Working-Hotelling</strong>:s metod skapa denna region. Strukturen från formel <a href="#eq-interval-base" class="quarto-xref">Ekvation&nbsp;<span>9.1</span></a> ger då följande formel:</p>
<p><span id="eq-interval-working-hotelling"><span class="math display">\[
\begin{aligned}
  \hat{Y}_{\mathbf{X}_0} \pm W \cdot s_{\hat{Y}_{\mathbf{X}_0}}
\end{aligned}
\tag{9.2}\]</span></span></p>
<p>där <span class="math inline">\(W^2 = 2\cdot F_{k+1; n-(k+1); 1-\alpha}\)</span>.</p>
<p>Denna beräkning tar redan hänsyn till alla möjliga punkter av <span class="math inline">\(\mathbf{X}\)</span> som regressionslinjen täcker, vilket innebär att samma formler kan användas för enstaka nya observationer, <span class="math inline">\(\mathbf{X}_{\mathbf{X}_0}\)</span>.</p>
<p>Även för prediktioner av responsvariabeln kan Bonferroni användas enligt: <span id="eq-interval-bonf-y"><span class="math display">\[
  \hat{Y}_{\mathbf{X}_0} \pm B \cdot s_{\hat{Y}_{\mathbf{X}_0}}
\tag{9.3}\]</span></span> där <span class="math inline">\(B = t_{n-(k+1); 1 - \alpha/(2\cdot g)}\)</span></p>
<p><a href="#eq-interval-working-hotelling" class="quarto-xref">Ekvation&nbsp;<span>9.2</span></a> ger generellt smalare intervall än <a href="#eq-interval-bonf-y" class="quarto-xref">Ekvation&nbsp;<span>9.3</span></a> då <span class="math inline">\(W\)</span> är samma värde oavsett hur många intervall som skattas medan <span class="math inline">\(B\)</span> ökar med antalet <span class="math inline">\(g\)</span>.</p>
</section>
<section id="skattning-av-flera-prediktionsintervall" class="level3" data-number="9.2.2">
<h3 data-number="9.2.2" class="anchored" data-anchor-id="skattning-av-flera-prediktionsintervall"><span class="header-section-number">9.2.2</span> Skattning av flera prediktionsintervall</h3>
<p>För enstaka nya observationer beräknas istället prediktionsintervall vilket innebär att skattningens medelfel förändras. Metoder för att beräkna <span class="math inline">\(g\)</span> prediktionsintervall är <strong>Scheffé</strong> och <strong>Bonferronis</strong> metoder.</p>
<p>Scheffés metod: <span class="math display">\[\begin{align}
   \hat{Y}_{\mathbf{X}_0} \pm S \cdot s_{pred}
\end{align}\]</span> där <span class="math display">\[\begin{align*}
    S &amp;= g \cdot F_{g; n-k+1; 1 - \alpha}\\
    s_{pred} &amp;= \sqrt{MSE + s^2_{\hat{Y}_{\mathbf{X}_0}}}
\end{align*}\]</span></p>
<p>Bonferronis metod: <span class="math display">\[\begin{align}
    \hat{Y}_{\mathbf{X}_0} \pm B \cdot s_{pred}
\end{align}\]</span> där <span class="math display">\[\begin{align*}
    B = t_{n-k+1; 1 - \alpha/(2\cdot g)}
\end{align*}\]</span></p>
<p>Båda dessa metoder kommer skapa bredare intervall i relation till antalet intervall som skattas eftersom <span class="math inline">\(g\)</span> inkluderas i båda beräkningarna. Detta skiljer sig från <a href="#eq-interval-working-hotelling" class="quarto-xref">Ekvation&nbsp;<span>9.2</span></a> där <span class="math inline">\(W\)</span> inte blir större desto fler intervall.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Kopierat!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Kopierat!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../01-regression/04-statistical-inference.html" class="pagination-link" aria-label="Statistisk inferens">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Statistisk inferens</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../01-regression/06-complex-predictors.html" class="pagination-link" aria-label="Komplexa samband">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Komplexa samband</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script>

// Script to highlight the current section in the navbar depending on which page you are on

document.addEventListener("DOMContentLoaded", function() {

    const currentPath = window.location.pathname;

    const navLinks = document.querySelectorAll(".navbar-nav .nav-link");



    navLinks.forEach(link => {

        const linkPath = new URL(link.href).pathname;



        // Highlight parent section if current path starts with link path

        if (currentPath.startsWith(linkPath)) {

            link.classList.add("active");

        } else {

            link.classList.remove("active");

        }

    });

});

</script>

<script>



/* definition of content for the buttons */

const webex_buttons = {check_hidden:          "<b>&check;</b>",

                       check_hidden_alt:      "Check answer",

                       check_shown:           "<b>&lsh;</b>",

                       check_shown_alt:       "Hide check",

                       check_of_total:        "/",

                       solution:              "<b>&quest;</b>",

                       solution_alt:          "Correct solution",

                       question_next:         "<b>&#8634;</b>",

                       question_next_alt:     "Next question",

                       question_previous:     "",

                       question_previous_alt: ""}





/* update total correct if #webex-total_correct exists */

update_total_correct = function() {

  console.log("webex: update total_correct");



  document.querySelectorAll(".webex-total_correct").forEach(total => {

    p = total.closest(".webex-box");

    var correct = p.getElementsByClassName("webex-correct").length;

    var solvemes = p.getElementsByClassName("webex-solveme").length;

    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;

    var selects = p.getElementsByClassName("webex-select").length;

    /* no specific class on input node, thus searching via query selector */

    var checkboxgroups = p.querySelectorAll("div[class=webex-checkboxgroup] input[type=checkbox]").length



    /* show number of correct / total number of answers */

    total.innerHTML = correct + "&nbsp;" + webex_buttons.check_of_total + "&nbsp;" + (solvemes + radiogroups + checkboxgroups + selects);

  });

}



/* check answers */

check_func = function() {

  console.log("webex: check answer");



  //var cl = elem.parentElement.classList;

  var cl = this.closest(".webex-box").classList;

  if (cl.contains("unchecked")) {

    cl.remove("unchecked");

    this.innerHTML = webex_buttons.check_shown; //"Hide check";

    if (webex_buttons.check_shown_alt.length > 0) this.setAttribute("title", webex_buttons.check_shown_alt);

  } else {

    cl.add("unchecked");

    this.innerHTML = webex_buttons.check_hidden; //"Check answer";

    if (webex_buttons.check_hidden_alt.length > 0) this.setAttribute("title", webex_buttons.check_hidden_alt);

  }

}



/* helper functions for checking the webex ID */

const id_checker = {"fmt": new RegExp("[g-zG-Z]"),

                    "load": function(e) { return e.getAttribute("id").match("(?<=(-)).*$")[0]; },

                    "eval": new TextEncoder(),

                    "dval": new TextDecoder()}



/* Show/hide correct solution */

solution_func = function() {

  console.log("webex: show/hide solution");



  var div = this.closest(".webex-question").querySelector(".webex-solution");

  var cl = div.classList;



  if (cl.contains("visible")) {

    cl.remove("visible");

  } else {

    cl.add("visible");

  }

}



/* function to check if the real answer is numeric */

convert_to_numeric = function(x) {

  if (typeof x == "string") {

    /* do nothing */

  } else if (x.length == 1) {

    /* take first element */

    x = x[0]

  } else {

    return NaN;

  }



  /* remove spaces for easier parsing */

  x = x.replace(/\s/g, "");



  /* Define patterns for different formats, note that spaces have been removed above */

  const patterns = [

    {regex: /^[+-]?\d+(\.\d{3})*,\d+$/, decimal: ",", thousand: "." },  // Format: "1.100.100.100,3"

    {regex: /^[+-]?\d+(,\d{3})*\.\d+$/, decimal: ".", thousand: "," },  // Format: "1,100,100,100.3"

    {regex: /^[+-]?\d+(\.|\.\d+)?$/, decimal: "." },                    // Format: "1100100100.5" or "1100100100."

    {regex: /^[+-]?\d+(,|,\d+)$/, decimal: "," }                        // Format: "1100100100,5" or "1100100100,"

  ];





  /* testing all regular expressions, convert to float if possible */

  for (const { regex, decimal, thousand } of patterns) {

    if (regex.test(x)) {

      let numeric = x;

      if (thousand) numeric = numeric.replace(new RegExp(`\\${thousand}`, "g"), "");

      numeric = numeric.replace(decimal, ".");

      return parseFloat(numeric);

    }

  }



  /* input of length 1 but none of the known formats, return NaN */

  return NaN;

}



/* Checking webex ID, returns formalsol */

check_id = function(e) {

  /* loading webex ID */

  var id = id_checker["load"](e);



  /* extracting answer */

  let answer = e.dataset.answer;



  /* checking unique id, prepare and return array */

  if (!id_checker["fmt"].test(id)) {

    const a = id_checker["eval"].encode(atob(answer));

    const b = id_checker["eval"].encode(id);

    const res = a.map((byte, index) => byte^b[index % b.length]);

    answer = id_checker["dval"].decode(res);

    /* Replacing &amp; with ' before parsing */

    answer = answer.replaceAll("&apos;", "'");

  }



  return JSON.parse(answer);

}



/* function for checking solveme answers */

solveme_func = function(e) {

  /* avoid that keyup and keychange twice execute this function within nms = 10

   * ms, clearing inputTimer and add timeout */

  console.log("webex: check solveme");



  /* float, precision for checking numeric answers */

  const eps = 0.00000000000001;



  /* get last checked user answer */

  const question = this.closest(".webex-question")



  /* extracting classes */

  var cl = this.classList;

  var my_answer = this.value;



  /* extracting classes */

  var cl = this.classList;



  /* empty answer? Job done */

  if (my_answer == "") {

    cl.remove("webex-correct");

    cl.remove("webex-incorrect");

    return false;

  }



  /* Find closest (parent) webex-question */

  let formalsols = check_id(this)



  /* by default we assume the users' answer is incorrect */

  var user_answer_correct = false;



  /* check if the correct answer is numeric, i.e. if 

   * formalsols is of length 1 containing one single numeric

   * value in a known format, else, NaN is returned */

  const num_formalsol = convert_to_numeric(formalsols);

  const num_my_answer = convert_to_numeric(my_answer);



  /* if the correct answer is numeric (float), the user's answer

   * must also be numeric. If not, it is wrong. Else we can

   * compare floating point numbers */

  if (!isNaN(num_formalsol) && !isNaN(num_my_answer)) {

    /* check if the real answer and the user input are numerically the same;

     * adding 'delta' to avoid precision issues */

    var diff = Math.abs(num_formalsol - num_my_answer);

    if (diff < parseFloat(this.dataset.tol) + eps) { user_answer_correct = true; }



  /* if the question contains regex, a regular expression is used

   * to evaluate the users answer. Allows for multiple regular expressions */

  } else if (cl.contains("regex")) {

    for (let i = 0; i < formalsols.length; i++) {

        let regex = new RegExp(formalsols[i], cl.contains("ignorecase") ? "i" : "");

        if (regex.test(my_answer)) { user_answer_correct = true; break; }

    }



  /* else we evaluate on 'string level', considering the creators preferences

   * regarding set options */

  } else {

    /* modify/prepare answer */

    if (cl.contains("ignorecase")) { my_answer = my_answer.toLowerCase(); }

    if (cl.contains("nospaces"))   { my_answer = my_answer.replace(/ /g, ""); }



    /* if the real answer includes user input - correct */

    if (formalsols.includes(my_answer)) {

      user_answer_correct = true;

  

      // added regex bit

      if (cl.contains("regex")) {

        answer_regex = RegExp(formalsols.join("|"))

        if (answer_regex.test(my_answer)) {

          cl.add("webex-correct");

        }

      }

    }

  }



  if (user_answer_correct) {

      cl.add("webex-correct");

      cl.remove("webex-incorrect");

  } else {

      cl.add("webex-incorrect");

      cl.remove("webex-correct");

  }



  update_total_correct();



}



/* function for checking select answers */

select_func = function(e) {

  console.log("webex: check select");



  var options   = [];

  Array.from(this.querySelectorAll("option")).forEach((option, index) => {

    if (!option.hasAttribute("value") || !option.getAttribute("value") === "blank") {

      options.push(option);

    }

  });



  /* get selected option */

  function get_selected(options) { return options.findIndex(option => option.selected); }

  var option_index = get_selected(options)



  /* loading webex ID */

  var formalsol = check_id(this)



  /* add class for current selection */

  this.classList.remove("webex-incorrect");

  this.classList.remove("webex-correct");

  if (option_index >= 0) {

    this.classList.add(formalsol[option_index] === 1 ? "webex-correct" : "webex-incorrect");

  }



  update_total_correct();

}



/* function for checking radiogroups answers */

radiogroups_func = function(e) {

  console.log("webex: check radiogroups");



  /* get real answer (binary integer array) */

  var id = e.target.getAttribute("name");

  var group = document.querySelector(".webex-radiogroup[id='webex-" + id + "']");

  var formalsol = check_id(group)



  /* check which radiobuttion is selected (user answer) */

  function get_checked(radios) {

    return radios.findIndex(radios => radios.checked);

  }

  var radios = Array.from(group.querySelectorAll("input[type='radio']"))

  var radio_index = get_checked(radios);



  /* remove existing classes */

  radios.forEach(radio => {

    let cl = radio.closest("label").classList

    cl.remove("webex-incorrect");

    cl.remove("webex-correct");

  });



  /* add class for current selection */

  let cl = radios[radio_index].closest("label").classList

  if (formalsol[radio_index] === 1) {

      cl.add("webex-correct");

  } else {

      cl.add("webex-incorrect");

  }



  update_total_correct();

}





/* function for checking checkboxgroups answers */

checkboxgroups_func = function(e) {

  console.log("webex: check checkboxgroups");



  /* get real answer (binary integer array) */

  var group = document.querySelector(".webex-checkboxgroup[id='" + this.id + "']");

  var formalsol = check_id(group);



  /* check which checkbox is checked (user answer) */

  function get_checked(group) {

      const checkboxes = Array.from(group.querySelectorAll("input[type='checkbox']"));

      return checkboxes.reduce((indices, checkbox, index) => {

          if (checkbox.checked) indices.push(index);

          return indices;

      }, []);

  }

  var checks = Array.from(group.querySelectorAll("input[type='checkbox']"));

  var check_index = get_checked(group);



  checks.forEach((e, index) => {

    var label = e.parentNode;

    var ans = formalsol[index];

    if ((e.checked && ans === 1) || (!e.checked && ans === 0)) {

        label.setAttribute("class", "webex-correct")

    } else {

        label.setAttribute("class", "webex-incorrect")

    }

  });



  update_total_correct();

}



/* shuffling array (thanks to stack overflow)

 * If argument x is an integer we create an integer sequence

 * from 0, 1, ..., (x - 1) and return a shuffled version. If

 * the input is an array, we simply shuffle it */

shuffle_array = function(x) {

   if (Number.isInteger(x) && !isNaN(x)) {

     x = Array.from({length: x}, (v, i) => i);

   }

   let shuffled = x.map(value => ({ value, sort: Math.random() }))

        .sort((a, b) => a.sort - b.sort).map(({ value }) => value)

   return shuffled;

}



/* ---------------------------------------------------------

 * ---------------------------------------------------------

 * --------------------------------------------------------- */

window.onload = function() {

  //console.log("webex: onload");



  /* setting up buttons and actions to show/hide answers */

  document.querySelectorAll(".webex-check").forEach(section => {

    section.classList.add("unchecked");



    /* ul to take up the list items with buttons */

    let button_ul = document.createElement("ul");

    button_ul.setAttribute("class", "webex-button-list");

    section.appendChild(button_ul);



    /* button to _check_ if answers given are correct */

    let li_check = document.createElement("li");

    button_ul.appendChild(li_check); /* add list item to ul */

    let btn_check = document.createElement("button");

    btn_check.innerHTML = webex_buttons.check_hidden;  // "Check answer";

    btn_check.setAttribute("class", "webex-button webex-button-check");

    if (webex_buttons.check_hidden_alt.length > 0) btn_check.setAttribute("title", webex_buttons.check_hidden_alt);

    btn_check.onclick = check_func;

    li_check.appendChild(btn_check);



    /* span to show current number of points (when _check_ active) */

    let spn = document.createElement("span");

    spn.classList.add("webex-total_correct");

    li_check.appendChild(spn);



    /* button to show the _solution_ if there is one */

    var has_solution = section.parentNode.querySelectorAll(".webex-solution").length > 0;

    if (has_solution) {

      let li_solution = document.createElement("li");

      button_ul.appendChild(li_solution); /* add list item to ul */

      let btn_solution = document.createElement("button");

      btn_solution.innerHTML = webex_buttons.solution; // "Correct answer";

      btn_solution.setAttribute("class", "webex-button webex-button-solution");

      if (webex_buttons.solution_alt.length > 0) btn_solution.setAttribute("title", webex_buttons.solution_alt);

      btn_solution.onclick = solution_func;

      li_solution.appendChild(btn_solution);

    }



  });



  /* set up webex-solveme inputs */

  document.querySelectorAll(".webex-solveme").forEach(solveme => {

    solveme.setAttribute("autocomplete","off");

    solveme.setAttribute("autocorrect", "off");

    solveme.setAttribute("autocapitalize", "off");

    solveme.setAttribute("spellcheck", "false");

    solveme.value = "";



    /* adjust answer for 'no spaces' (ignore spaces) */

    if (solveme.classList.contains("nospaces")) {

      solveme.dataset.answer = solveme.dataset.answer.replace(/ /g, "");

    }



    /* attach checking function, triggered on key up, change, and when

     * elemnt is out of focus. Only evaluated once by tracking changes

     * via variable solveme_last_user_answer */

    solveme.addEventListener("keyup",  solveme_func);

    solveme.addEventListener("change", solveme_func);

    solveme.addEventListener("blur",   solveme_func);



    /* adding span to show correct/incorrect icon */

    solveme.insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")

  });



  /* set up radiogroups (single choice questions with display = "buttons") */

  document.querySelectorAll(".webex-radiogroup").forEach(radiogroup => {

    radiogroup.onchange = radiogroups_func;

  });



  /* set up checkboxgroups (multiple choice questions with display = "buttons") */

  document.querySelectorAll(".webex-checkboxgroup").forEach(checkboxgroup => {

    checkboxgroup.onchange = checkboxgroups_func;

  });



  /* set up selects (dropdown menus) */

  document.querySelectorAll(".webex-select").forEach(select => {

    select.onchange = select_func;

    /* append webex-icon for correct/incorrect icons */

    var elem = document.createElement("span")

    elem.classList.add("webex-icon")

    select.parentNode.appendChild(elem)

  });



  /* change to next/previous question if multiple are available */

  function handleQuestionClick(group, questions, step) {

    return async function() {

      /* get question order as integer vector */

      let questionOrder = group.dataset.questionOrder.split(",").map(str => parseInt(str));



      /* current question/position */

      let currentPosition = parseInt(group.dataset.currentPosition);



      /* Hide the current question */

      questions.forEach(question => { question.classList.remove("active"); });



      /* Move to the next question index */

      currentPosition = (currentPosition + step) % questionOrder.length;

      if (currentPosition < 0) currentPosition = currentPosition + questionOrder.length



      /* Display the new question */

      questions[questionOrder[currentPosition]].classList.add("active");



      // Update the currentPosition data attribute on the group div

      group.dataset.currentPosition = currentPosition;

    };

  }



  document.querySelectorAll(".webex-group").forEach(group => {

    const questions = Array.from(group.querySelectorAll(".webex-question"));



    /* Create vector with question order. If the webex-group does

     * not have class '.noshuffle' we will randomly shuffle the order */

    let questionOrder = Array.from({length: questions.length}, (v, i) => i);

    if (!group.classList.contains("noshuffle")) {

      questionOrder = shuffle_array(questionOrder);

    }



    /* take start position (if set) or start at 0 */

    const currentPosition = parseInt(group.getAttribute("data-start-position")) || 0;



    /* show the default question for each group */

    questions[questionOrder[currentPosition]].classList.add("active");



    /* store random order of questions as well as current position */

    group.dataset.questionOrder   = questionOrder;

    group.dataset.currentPosition = currentPosition;



    /* find all webex-questions, search for .webex-button-list and

     * populate the list with necessary <li><button>...</button></li> elements */

    questions.forEach(question => {

        let button_ul = question.querySelector("ul.webex-button-list");



        let li_next = document.createElement("li");

        let nextButton = document.createElement("button");

        nextButton.setAttribute("class", "webex-button webex-button-next");

        if (webex_buttons.question_next_alt.length > 0) nextButton.setAttribute("title", webex_buttons.question_next_alt);

        nextButton.innerHTML = webex_buttons.question_next; // "Next question";

        nextButton.addEventListener("click", handleQuestionClick(group, questions, 1));

        li_next.appendChild(nextButton);



        let li_previous = document.createElement("li");

        let previousButton = document.createElement("button");

        previousButton.setAttribute("class", "webex-button webex-button-previous");

        if (webex_buttons.question_previous_alt.length > 0) previousButton.setAttribute("title", webex_buttons.question_previous_alt);

        previousButton.innerHTML = webex_buttons.question_previous; // "Previous question";

        previousButton.addEventListener("click", handleQuestionClick(group, questions, -1));

        li_previous.appendChild(previousButton);



        if (webex_buttons.question_previous.length > 0) button_ul.appendChild(li_previous);

        if (webex_buttons.question_next.length > 0) button_ul.appendChild(li_next);

    });

  });



  /* Development options */

  document.querySelectorAll(".webex-question.check").forEach(question => {

      question.querySelector(".webex-button-check").click()

  });

  document.querySelectorAll(".webex-question.solution").forEach(question => {

      let btn = question.querySelector(".webex-button-solution");

      if (btn !== null) { btn.click(); }

  });



  /* Pre-filling <input> fields */

  document.querySelectorAll(".webex-question.prefill").forEach(question => {

      question.querySelectorAll("input.webex-solveme").forEach(solveme => {

          let x = JSON.parse(solveme.dataset.answer);

          solveme.value = x[0];

          /* Trigger the on change event */

          solveme.dispatchEvent(new Event("change"));

      });



      /* Pre-filling radiogroups, that is for schoice questions */

      question.querySelectorAll(".webex-radiogroup").forEach(radiogroup => {

          let x = JSON.parse(radiogroup.dataset.answer);

          let idx = x.indexOf(1);

          let radios = radiogroup.querySelectorAll('input[type="radio"]');

          radios[idx].checked = true;

          /* Trigger the on change event */

          radios[idx].dispatchEvent(new Event("change", { bubbles: true }));

      });



      /* Pre-filling checkboxgroups, that is for schoice questions w/ dropdown menus */

      question.querySelectorAll(".webex-select").forEach(dropdown => {

          let x = JSON.parse(dropdown.dataset.answer);

          let idx = x.indexOf(1) + 1; /* +1 to skip the first blank option */

          let options = dropdown.querySelectorAll("option");

          options[idx].selected = true;

          /* Trigger the on change event */

          options[idx].dispatchEvent(new Event("change", { bubbles: true }));

      });



      /* Pre-filling checkboxgroups, that is for mchoice questions */

      question.querySelectorAll(".webex-checkboxgroup").forEach(radiogroup => {

          let x = JSON.parse(radiogroup.dataset.answer);

          let checkboxes = radiogroup.querySelectorAll('input[type="checkbox"]');

          for (let i = 0; i < checkboxes.length; i++) {

              checkboxes[i].checked = x[i];

          }

          /* Trigger the on change event */

          checkboxes[0].dispatchEvent(new Event("change", { bubbles: true }));

      });

  });



  /* Show set tolerance (devel option) */

  function calc_width(x, txt, offset = 20) {

      /* We do the following:

       * Create a new span, insert the value we need in the .tolerance

       * input node, and calculate its offsetWidth. Then remove it

       * again; this is just used to calculate the required width. */

      var cwtmp = document.createElement("span");

      x.appendChild(cwtmp);

      cwtmp.innerHTML = txt || "";

      var w = parseInt(cwtmp.getBoundingClientRect().width) + offset;

      cwtmp.remove();

      return w;

  }



  /* If tolerance should be shown (devel option) we calculate:

   * - the width required to properly display the solution

   * - the width required to properly display the tolerance

   * - add a new element to display the tolerance

   * - reduce the width of the solution input box. */

  document.querySelectorAll(".webex-question.tolerance").forEach(question => {

      question.querySelectorAll("input[data-tol]").forEach(elem => {

          var w = null;



          /* Add new element showing the tolerance */

          let tol = document.createElement("input");

          tol.type = "text"; // <inpyt type="text">

          tol.disabled = true; // Disable input element

          tol.classList.add("tolerance"); // Appending class

          tol.value = "Â± " + elem.getAttribute("data-tol");



          /* Add new node */

          elem.parentNode.insertBefore(tol, elem)



          var body     = document.querySelector("body");

          //tol.value = "Â± " + "0.0000007";

          //tol.value = "Â± " + "0.07";

          w    = calc_width(body, tol.value);

          wold = parseInt(elem.getBoundingClientRect().width);

          wmin = calc_width(body, elem.value);



          /* Calculate required width of the 'tolerance' node, and the

           * reduction of the original 'input' node */

          let wnew = Math.max(wmin, wold - w);

          tol.style.width  = w + "px";

          elem.style.width = wnew + "px";

      });

  });



  update_total_correct();

}



</script>




</body></html>