---
engine: knitr
filters: 
  - webr
---
<!-- CONTENT -->

# AR och MA modeller

Hur kan en tidsserie utan en tydlig trend eller säsongsmönster modelleras? Vi kan på olika sätt ta tillvara på tidsberoendet i serien genom **autoregressiva** (AR) processer som innebär regression "på sig själv" och genom **glidande medelvärde** (MA) processer som innebär regression på tidigare feltermer.

I detta kapitel kommer dessa två processer att presenteras separat för att i nästa kapitel visa hur de kan sammanfogas till en gemensam modell. Vi kommer titta på hur processerna ser ut i teorin och vilka egenskaper de uppvisar för att lättare kunna identifiera när specifika processer är lämpliga modellval för en observerad serie.

## Autoregressiva processer
 
En autoregressiv process använder beroendet mellan olika tidpunkter som hjälpvariabler i en modell som väldigt mycket liknar en linjär regressionsmodell. Generellt kan vi beskriva en AR(p)-process som:
$$
  \begin{aligned}
  Y_t = \phi_1 Y_{t-1} + \phi_2 Y_{t-2} + \dots + \phi_p Y_{t-p} + e_t
  \end{aligned}
$$ {#eq-arp}
det vill säga att $Y_t$ förklaras av en linjärkombination av $p$ tidigare värden. Vardera $\phi$ (grekiska bokstaven phi^[Uttalas fi.]) beskriver relationen mellan det specifika lagget och den nuvarande tidpunkten. Alla $Y_t$ är oberoende från $e_t$. 

När vi visar denna process antas att $E[Y_t] = 0$ men vi kan enkelt utöka modellen till att ha $\mu$ som medelvärde genom att formulera $Y_t - \mu$ i vänsterledet.

<!-- TODO WHERE TO PUT 4.1/4.2? MAYBE SOMETHING IN RELATION TO THE MA PROCESS LAST IN THIS CHAPTER -->

### AR(1)

Den enklaste formen av en autoregressiv modell är en AR(1):
$$
  \begin{aligned}
  Y_t = \phi Y_{t-1} + e_t
  \end{aligned}
$$ {#eq-ar1}

Denna modell antar att $Y_t$ endast beror på den föregående tidpunkten och ett slumpfel. Detta slumpfel kan beskrivas som den nya informationen som nuvarande tidpunkt introducerar till serien.

Vi kan simulera hur en AR(1) ser ut för olika värden på $\phi$.

```{webr-r}
#| fig-width: 5
#| fig-height: 3
#| fig-cap: Simulerad AR(1) serie från angivet $\phi$
#| out-width: "90%"
#| autorun: true

# Skapar en funktion för att simulera en AR(1) process
ar1 <- function(phi, n) {
  yt <- numeric()
  
  for (i in seq_len(n)) {
    if (i == 1) {
      yt[i] <- rnorm(n = 1)
    } else {
      yt[i] <- phi * yt[i-1] + rnorm(n = 1)
    }
  }
  
  yt
}

# Egenskaper för simuleringen
n <- 100
phi <- 0.9

# Visualisera serien i ett linjediagram
tibble(
  t = seq_len(n),
  yt = ar1(phi = phi, n = n)
) |> 
  ggplot() + aes(x = t, y = yt) + geom_line() + 
  theme_bw()
```

En av serierna vi tittade på i föregående kapitel, Random Walk i @eq-random-walk, är ett specialfall av en AR(1) process när $\phi = 1$. Vi bedömde tidigare att en Random Walk inte var en stationär serie så hur kan vi säkerställa att en AR-process uppfyller stationäritet? Hur behöver vi begränsa $\phi$ för att detta ska uppfyllas för en AR(1)?

Vi kan börja med att beräkna variansen av @eq-ar1:

$$
  \begin{aligned}
  Var(Y_t) = \gamma_0 &= Var(\phi Y_{t-1} + e_t) \\
  \gamma_0 &= \phi^2Var(Y_{t-1}) + Var(e_t) && \text{(pga oberoende)}\\
  \gamma_0 &= \phi^2 \gamma_0 + \sigma^2_e \\
  \gamma_0 &= \frac{\sigma^2_e}{1 - \phi^2}
  \end{aligned}
$$

:::{.callout-note}
Kom ihåg att $\gamma_0 = cov(Y_t, Y_t) = Var(Y_t)$ gäller för alla $Y_{t-k}$ där $k \ge 0$.
:::

Redan vid detta uttryck ser vi några begränsningar som måste göras, nämligen $|\phi| < 1$, för att variansen ska vara definierbar och strikt positiv. Vi kallar detta för seriens **villkor för stationäritet**.

Autokovariansen för lagg $k$ blir då:

$$
  \begin{aligned}
  \gamma_k = \phi \gamma_{k-1} + E\left[e_t Y_{t-k}\right]
  \end{aligned}
$$
som pga oberoendet mellan $e_t$ och $Y_t$ ger:
$$
  \begin{aligned}
  \gamma_k = \phi \gamma_{k-1}
  \end{aligned}
$$ {#eq-rho-ar1}
för alla $k > 0$.

Vi kan utveckla denna ekvation för att hitta ett annat sätt att formulera autokovariansen.
$$
  \begin{aligned}
    \gamma_1 &= \phi \gamma_0 &&= \phi \frac{\sigma^2_e}{1 - \phi^2}\\
    \gamma_2 &= \phi \gamma_1 &&= \phi \phi \frac{\sigma^2_e}{1 - \phi^2}\\
    &&&= \phi^2 \frac{\sigma^2_e}{1 - \phi^2} \\
    \gamma_3 &= \phi \gamma_2 &&= \phi^3 \frac{\sigma^2_e}{1 - \phi^2}\\
    &&\vdots\\
    \gamma_k & &&= \phi^k \frac{\sigma^2_e}{1 - \phi^2}
  \end{aligned}
$$

Med hjälp av denna formulering kan vi reducera autokorrelationen till:

$$
  \begin{aligned}
  \rho_k = \frac{\gamma_k}{\sqrt{\gamma_0 \cdot \gamma_0}} = \frac{\gamma_k}{\gamma_0} = \frac{\phi^k \frac{\sigma^2_e}{1 - \phi^2}}{\frac{\sigma^2_e}{1 - \phi^2}} = \phi^k
  \end{aligned}
$$
det vill säga en exponentiellt minskande korrelation då $|\phi| < 1$. 

Med hjälp av dessa härledningar kan vi visualisera hur $\rho_k$ ser ut för olika värden på $\phi$. Detta kommer hjälpa oss att identifiera fall där en AR(1) modell kan användas som en representation av en tidsserie.

```{webr-r}
#| fig-width: 5
#| fig-height: 3
#| fig-cap: Autokorrelationen för en AR(1) med olika phi
#| out-width: "90%"

# Ange ett värde på phi i processen
phi <- 0.9

tibble(
  k = seq_len(20), 
  rho = phi^k
) |> 
  ggplot() + aes(x = k, y = rho) + 
  geom_bar(width = 0.3, stat = "identity") +
  scale_y_continuous(limits = c(-1, 1)) + 
  geom_hline(yintercept = 0, linewidth = 1) +
  labs(y = expression(rho[k])) + 
  theme_bw()

```

Testa att ändra `phi` till olika lämpliga värden, $|\phi| < 1$, och se vad som händer med visualiseringen. Testa även negativa tal och se hur det förändrar $\rho_k$.

Figuren visar ett snabbt avtagande mönster till skillnad från det långsamt avtagande, nästan cycliska mönster som Random Walk uppvisade. Detta visar att när vi begränsar $\phi$ enligt dess stationäritetsvilkor blir serien stationär.


## AR(2)

Om vi utökar modellen med ytterligare ett lagg fås:
$$
  \begin{aligned}
  Y_t = \phi_1 Y_{t-1} + \phi_2 Y_{t-2} + e_t
  \end{aligned}
$$

Att visa villkoren för stationäritet blir mer och mer komplicerat för större $p$ men vi har för en AR(2) följande tre villkor:^[Se @cryer2008 sid 84]

$$
  \begin{aligned}
  \phi_1 + \phi_2 < 1 \qquad \phi_2 - \phi_1 < 1 \qquad |\phi_2| < 1
  \end{aligned}
$$



<!-- TODO: Matcha par av stationäritetsvillkor för olika serier -->



Något kort om MA



